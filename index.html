<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- è§£å†³è±†ç“£å›¾ç‰‡åŠ äº†é˜²ç›—é“¾ï¼Œæ— æ³•æ˜¾ç¤ºçš„é—®é¢˜ -->
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è±†ç“£å½±è§†</title>
  <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
  <style>
    a {
      text-decoration: none;
    }
    .content {
      display: flex;
      /* æ¢è¡Œæ˜¾ç¤º */
      flex-wrap: wrap;
      justify-content: space-around;
      text-align: center;
    }
    .list {
      display: flex;
      /* å®šä¹‰ä¸»è½´æ”¾ä¸‹ï¼šä¸Šä¸‹ */
      flex-direction: column;
      margin-left: 10px;
      margin-top: 10px;
      position: relative;
    }
    .d-canvas {
      width: 60px;
      height: 60px;
      background-color: #081c22;
      border-radius: 50%;
      position: absolute;
      right: 4px;
      top: 316px;
    }
    img {
      width: 270px;
      height: 380px;
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="content" id="content">

    </div>
  </div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
  function drawMain(drawing_elem, percent, forecolor, bgcolor) {
 /*
    å€Ÿé‰´åœ°å€ï¼š[canvas ç»˜åˆ¶åŠ¨æ€åœ†ç¯è¿›åº¦æ¡_canvas ç¯å½¢è¿›åº¦æ¡ èƒŒæ™¯è‰²_å‰ç«¯å°ç™½çš„æ±Ÿæ¹–è·¯çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_21058391/article/details/76691047)
    https://github.com/klren0312/daliy_knowledge/issues/63
    @drawing_elem: ç»˜åˆ¶å¯¹è±¡
    @percentï¼šç»˜åˆ¶åœ†ç¯ç™¾åˆ†æ¯”, èŒƒå›´[0, 100]
    @forecolor: ç»˜åˆ¶åœ†ç¯çš„å‰æ™¯è‰²ï¼Œé¢œè‰²ä»£ç 
    @bgcolor: ç»˜åˆ¶åœ†ç¯çš„èƒŒæ™¯è‰²ï¼Œé¢œè‰²ä»£ç 
 */
 var context = drawing_elem.getContext("2d");
 var center_x = drawing_elem.width / 2;
 var center_y = drawing_elem.height / 2;
 var rad = Math.PI*2/100;    
 var speed = 0;
 var width = drawing_elem.width;
 var  height = drawing_elem.height;
  if (window.devicePixelRatio) { //ç§»åŠ¨ç«¯é”¯é½¿è§£å†³æ–¹æ¡ˆ
    drawing_elem.style.width = width + "px";
    drawing_elem.style.height = height + "px";
    drawing_elem.height = height * window.devicePixelRatio;
    drawing_elem.width = width * window.devicePixelRatio;
    context.scale(window.devicePixelRatio, window.devicePixelRatio);
  }

    
 // ç»˜åˆ¶èƒŒæ™¯åœ†åœˆ
 function backgroundCircle(){
    context.save();
    context.beginPath();
    context.lineWidth = 8; //è®¾ç½®çº¿å®½
    var radius = center_x - context.lineWidth;
    context.lineCap = "round";
    context.strokeStyle = bgcolor;
    context.arc(center_x, center_y, radius, 0, Math.PI*2, false);
    context.stroke();
    context.closePath();
    context.restore();
 }
    
 //ç»˜åˆ¶è¿åŠ¨åœ†ç¯
 function foregroundCircle(n){
    context.save();
    context.strokeStyle = forecolor;
    context.lineWidth = 8;
    context.lineCap = "round";
    var radius = center_x - context.lineWidth;
    context.beginPath();
    context.arc(center_x, center_y, radius , -Math.PI/2, -Math.PI/2 +n*rad, false); //ç”¨äºç»˜åˆ¶åœ†å¼§context.arc(xåæ ‡ï¼Œyåæ ‡ï¼ŒåŠå¾„ï¼Œèµ·å§‹è§’åº¦ï¼Œç»ˆæ­¢è§’åº¦ï¼Œé¡ºæ—¶é’ˆ/é€†æ—¶é’ˆ)
    context.stroke();
    context.closePath();
    context.restore();
 }
    
 //ç»˜åˆ¶æ–‡å­—
 function text(n){
    context.save(); //saveå’Œrestoreå¯ä»¥ä¿è¯æ ·å¼å±æ€§åªè¿ç”¨äºè¯¥æ®µcanvaså…ƒç´ 
    context.fillStyle = forecolor;
    var font_size = 12;
    context.font = font_size + "px Helvetica";
    // è¯¥å¯¹è±¡åŒ…å«æœ‰å…³æµ‹é‡æ–‡æœ¬çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚å…¶å®½åº¦ï¼‰
    var text_width = context.measureText(n.toFixed(0)+"%").width;
    context.fillText(n.toFixed(0)+"%", center_x-text_width/2, center_y + font_size/2);
    context.restore();
 }
    
 //æ‰§è¡ŒåŠ¨ç”»
//  (function drawFrame(){
    // window.requestAnimationFrame(drawFrame);
    context.clearRect(0, 0, drawing_elem.width, drawing_elem.height);
    backgroundCircle();
    text(percent);
    foregroundCircle(percent);
    // if(speed >= percent) return;
    // speed += 1;
//  }());
  }
  var jsonData='./data/douban/movie.json';
  // ä½¿ç”¨$.ajax()æ–¹æ³•è·å–æœ¬åœ°JSONæ–‡ä»¶

  $.ajax({
    url: jsonData,
    dataType: 'json',
    success: function(data) {
      // å½“è·å–æˆåŠŸæ—¶ï¼Œä½¿ç”¨$.parseJSON()æ–¹æ³•è§£æJSONæ•°æ®
      var jsonObj = $.parseJSON(JSON.stringify(data));

      let title= '';
      let picNormal = '';
      var canvases = [];
      // é¡µé¢å†…å®¹
      var $content = $('#content')
      console.log(jsonObj);
      for(let i=0; i<jsonObj.length; i++){
        
        let jsonObjData = jsonObj[i];
        // ç”µå½±ä¿¡æ¯
        let subject = jsonObjData['subject'];
        // è¯„åˆ†
        let rating = jsonObjData['rating'];
        // ç”µå½±é¢˜ç›®
        title = subject['title'];
        // ç”µå½±ä¿¡æ¯
        sharing_url = subject['sharing_url'];
        // ç”µå½±ç…§ç‰‡
        picNormal = subject['pic']['normal'];
        // å®˜æ–¹è¯„åˆ†
        let ratings = subject['rating'];
        let ratings_value = ratings['value'];
        let ratings_star_count = ratings['star_count'];
        
        // åˆ›å»ºæ–°çš„Div
        var newDiv = $("<div></div>");
        var canvasDiv = $("<div></div>");
        newDiv.addClass('list');
        canvasDiv.addClass('d-canvas')
        var newLink = $("<a></a>").attr({
				"href": sharing_url,
        "target": '_blank',
				"alt": title
        });
        // æ˜¾ç¤ºç”µå½±é¢˜ç›®
        var $span = $('<h2>').text(title);
        // æ˜¾ç¤ºç”µå½±ç…§ç‰‡
        var newImg = $("<img />").attr({
				"src": picNormal,
				"alt": title
        });
        // æ˜¾ç¤ºä¸ªäººè¯„åˆ†
        var $span_star = $('<span>');
        
        if (rating != null){
          $span_star.append('ä¸ªäººè¯„åˆ†ï¼š');
          let star_count = rating['star_count'];
          // console.log(star_count);
          for(let j=0; j<star_count; j++){
            $span_star = $span_star.append('ğŸŒŸ');
          }
        }else{
          $span_star.append('ä¸ªäººè¯„åˆ†ï¼šæœªè¯„åˆ†');
        }
        var $ratings_star_span = $('<span>');
        $ratings_star_span.append('è±†ç“£è¯„åˆ†ï¼š')
        for(let k=0; k<ratings_star_count; k++){
          $ratings_star_span = $ratings_star_span.append('ğŸŒŸ');
        }

        var ratings_star_canvas = $('<canvas>').attr({
          width: 60,
          height: 60
        });
        ratings_star_canvas.attr('id', 'canvas' + i);
        drawMain(ratings_star_canvas[0], ratings_value*10, "#85d824", "#eef7e4");
        $ratings_star_span.append('&nbsp;&nbsp;&nbsp;'+ratings_value+'/10');
        newLink.append(newImg);
        canvasDiv.append(ratings_star_canvas);
        newDiv.append(canvasDiv);
        newDiv.append(newLink);
        newDiv.append($span);
        newDiv.append($span_star);
        newDiv.append($ratings_star_span);
        $content.append(newDiv);
        
      }
      
    },
    error: function(xhr, status, error) {
      // å¤„ç†é”™è¯¯æƒ…å†µ
      console.log('è·å–JSONæ•°æ®å¤±è´¥ï¼š' + error);
    }
  });
</script>
</html>