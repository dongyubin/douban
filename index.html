<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- è§£å†³è±†ç“£å›¾ç‰‡åŠ äº†é˜²ç›—é“¾ï¼Œæ— æ³•æ˜¾ç¤ºçš„é—®é¢˜ -->
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è±†ç“£å½±è§†</title>
  <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
  <style>
    a {
      text-decoration: none;
    }
    .container{
      width: 100%;
      height: 100%;
    }
    .filter{
      margin-left: 20px;
    }
    .stars,.genres,.years {
      margin-top: 10px;
    }
    .content {
      display: flex;
      /* æ¢è¡Œæ˜¾ç¤º */
      flex-wrap: wrap;
      justify-content: space-around;
      text-align: center;
    }
    .list {
      display: flex;
      /* å®šä¹‰ä¸»è½´æ”¾ä¸‹ï¼šä¸Šä¸‹ */
      flex-direction: column;
      margin-left: 10px;
      margin-top: 10px;
      position: relative;
    }
    .d-canvas {
      width: 60px;
      height: 60px;
      background-color: #081c22;
      border-radius: 50%;
      position: absolute;
      right: 4px;
      top: 316px;
    }
    img {
      width: 270px;
      height: 380px;
    }
    .active {
      color: #fff;
      background-color: #081c22;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="filter">
      <div class="genres">
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="">å…¨éƒ¨</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="åŠ¨ä½œ">åŠ¨ä½œ</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="åŠ¨ç”»">åŠ¨ç”»</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å–œå‰§">å–œå‰§</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å†å²">å†å²</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="ç§‘å¹»">ç§‘å¹»</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="çºªå½•ç‰‡">çºªå½•ç‰‡</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å‰§æƒ…">å‰§æƒ…</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å¥‡å¹»">å¥‡å¹»</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="çŠ¯ç½ª">çŠ¯ç½ª</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="è¿åŠ¨">è¿åŠ¨</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å®¶åº­">å®¶åº­</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="æ‚¬ç–‘">æ‚¬ç–‘</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å¤è£…">å¤è£…</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="æˆ˜äº‰">æˆ˜äº‰</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="æ­¦ä¾ ">æ­¦ä¾ </a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å†’é™©">å†’é™©</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="ç¾éš¾">ç¾éš¾</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="çˆ±æƒ…">çˆ±æƒ…</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="çœŸäººç§€">çœŸäººç§€</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="éŸ³ä¹">éŸ³ä¹</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="è„±å£ç§€">è„±å£ç§€</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="çŸ­ç‰‡">çŸ­ç‰‡</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="æƒŠæ‚š">æƒŠæ‚š</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="æ­Œèˆ">æ­Œèˆ</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="ä¼ è®°">ä¼ è®°</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="å„¿ç«¥">å„¿ç«¥</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="ææ€–">ææ€–</a>
        <a href="javascript:void 0;" class="search" data-search="genres" data-value="è¥¿éƒ¨">è¥¿éƒ¨</a>
      </div>
      <div class="years">
        <a href="javascript:void 0;" class="search" data-search="year" data-value="">å…¨éƒ¨</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2023">2023</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2022">2022</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2021">2021</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2020">2020</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2019">2019</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2018">2018</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2017">2017</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2016">2016</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2015">2015</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2014">2014</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2013">2013</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2012">2012</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2011">2011</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2010">2010</a>
        <a href="javascript:void 0;" class="search" data-search="year" data-value="2009">2009</a>
      </div>
      <div class="stars">
        <a href="javascript:void 0;" class="search" data-search="star" data-value="">å…¨éƒ¨</a>
        <a href="javascript:void 0;" class="search" data-search="star" data-value="5">äº”æ˜Ÿ</a>
        <a href="javascript:void 0;" class="search" data-search="star" data-value="4">å››æ˜Ÿ</a>
        <a href="javascript:void 0;" class="search" data-search="star" data-value="3">ä¸‰æ˜Ÿ</a>
        <a href="javascript:void 0;" class="search" data-search="star" data-value="2">äºŒæ˜Ÿ</a>
        <a href="javascript:void 0;" class="search" data-search="star" data-value="1">ä¸€æ˜Ÿ</a>
      </div>
    </div>
    <div class="content" id="content">

    </div>
  </div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
  function drawMain(drawing_elem, percent, forecolor, bgcolor) {
    /*
        å€Ÿé‰´åœ°å€ï¼š[canvas ç»˜åˆ¶åŠ¨æ€åœ†ç¯è¿›åº¦æ¡_canvas ç¯å½¢è¿›åº¦æ¡ èƒŒæ™¯è‰²_å‰ç«¯å°ç™½çš„æ±Ÿæ¹–è·¯çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_21058391/article/details/76691047)
        https://github.com/klren0312/daliy_knowledge/issues/63
        @drawing_elem: ç»˜åˆ¶å¯¹è±¡
        @percentï¼šç»˜åˆ¶åœ†ç¯ç™¾åˆ†æ¯”, èŒƒå›´[0, 100]
        @forecolor: ç»˜åˆ¶åœ†ç¯çš„å‰æ™¯è‰²ï¼Œé¢œè‰²ä»£ç 
        @bgcolor: ç»˜åˆ¶åœ†ç¯çš„èƒŒæ™¯è‰²ï¼Œé¢œè‰²ä»£ç 
    */
    var context = drawing_elem.getContext("2d");
    var center_x = drawing_elem.width / 2;
    var center_y = drawing_elem.height / 2;
    var rad = Math.PI*2/100;    
    var speed = 0;
    var width = drawing_elem.width;
    var  height = drawing_elem.height;
    
    if (window.devicePixelRatio) { //ç§»åŠ¨ç«¯é”¯é½¿è§£å†³æ–¹æ¡ˆ
      drawing_elem.style.width = width + "px";
      drawing_elem.style.height = height + "px";
      drawing_elem.height = height * window.devicePixelRatio;
      drawing_elem.width = width * window.devicePixelRatio;
      context.scale(window.devicePixelRatio, window.devicePixelRatio);
    }

    
    // ç»˜åˆ¶èƒŒæ™¯åœ†åœˆ
    function backgroundCircle(){
      context.save();
      context.beginPath();
      context.lineWidth = 8; //è®¾ç½®çº¿å®½
      var radius = center_x - context.lineWidth;
      context.lineCap = "round";
      context.strokeStyle = bgcolor;
      context.arc(center_x, center_y, radius, 0, Math.PI*2, false);
      context.stroke();
      context.closePath();
      context.restore();
    }
        
    //ç»˜åˆ¶è¿åŠ¨åœ†ç¯
    function foregroundCircle(n){
      context.save();
      context.strokeStyle = forecolor;
      context.lineWidth = 8;
      context.lineCap = "round";
      var radius = center_x - context.lineWidth;
      context.beginPath();
      context.arc(center_x, center_y, radius , -Math.PI/2, -Math.PI/2 +n*rad, false); //ç”¨äºç»˜åˆ¶åœ†å¼§context.arc(xåæ ‡ï¼Œyåæ ‡ï¼ŒåŠå¾„ï¼Œèµ·å§‹è§’åº¦ï¼Œç»ˆæ­¢è§’åº¦ï¼Œé¡ºæ—¶é’ˆ/é€†æ—¶é’ˆ)
      context.stroke();
      context.closePath();
      context.restore();
    }
        
    //ç»˜åˆ¶æ–‡å­—
    function text(n){
      context.save(); //saveå’Œrestoreå¯ä»¥ä¿è¯æ ·å¼å±æ€§åªè¿ç”¨äºè¯¥æ®µcanvaså…ƒç´ 
      context.fillStyle = '#fff';
      var font_size = 12;
      context.font = font_size + "px Helvetica";
      // è¯¥å¯¹è±¡åŒ…å«æœ‰å…³æµ‹é‡æ–‡æœ¬çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚å…¶å®½åº¦ï¼‰
      var text_width = context.measureText(n.toFixed(0)+"%").width;
      context.fillText(n.toFixed(0)+"%", center_x-text_width/2, center_y + font_size/2);
      context.restore();
    }
    
 //æ‰§è¡ŒåŠ¨ç”»
//  (function drawFrame(){
    // window.requestAnimationFrame(drawFrame);
    context.clearRect(0, 0, drawing_elem.width, drawing_elem.height);
    backgroundCircle();
    text(percent);
    foregroundCircle(percent);
    // if(speed >= percent) return;
    // speed += 1;
//  }());
  }
  var jsonFile='./data/douban/movie.json';
  getData(jsonFile);

  /**
   * é€šè¿‡ç‚¹å‡»äº‹ä»¶é«˜äº®ç­›é€‰æ¡ä»¶
  */
  document.addEventListener('click',function(e){
    if(e.target.classList.contains('search')){
      event.preventDefault(); // é˜²æ­¢é»˜è®¤ç‚¹å‡»è¡Œä¸º
      var search_type = e.target.dataset.search;
      document.querySelector(`.active[data-search="${search_type}"]`)?.classList.remove('active')
      var conditions = {};
      if(e.target.dataset.value){
        e.target.classList.add('active')
      }
    }
    getData(jsonFile);
  })

  // ä½¿ç”¨$.ajax()æ–¹æ³•è·å–æœ¬åœ°JSONæ–‡ä»¶
  function getData(file){
    $.ajax({
    url: file,
    dataType: 'json',
    success: function(data) {
      var filteredData;
      var conditions = {}
      var content = $('#content');
      // åˆ¤æ–­æ˜¯å¦æœ‰ç­›é€‰æ¡ä»¶
      if($('.search.active').length!=0){
        for(let i=0;i<$('.search.active').length;i++){
          var active_type = $('.search.active')[i].dataset['search'];
          var active_value = $('.search.active')[i].dataset['value'];
          conditions[active_type] = active_value;
        }
        console.log(conditions);
        // åˆ¤æ–­ç­›é€‰æ¡ä»¶æ˜¯å¦é€‰æ‹©
        const year = conditions['year'];
        const star = conditions['star'];
        const genres = conditions['genres'];

        // ä¸‹é¢ä»£ç çš„ç®€å†™æ–¹å¼
        filteredData = data.filter(
          item => 
            (typeof(year) === 'undefined' || item.subject.year == year) &&
            (typeof(star) === 'undefined' || Math.round(item.subject.rating.star_count) == star) &&
            (typeof(genres) === 'undefined' || item.subject.genres.indexOf(genres) > -1)
        );
        
        // if (typeof(conditions['year']) == "undefined" && typeof(conditions['genres']) == "undefined"){
        //   filteredData = data.filter(
        //     item => Math.round(item.subject.rating.star_count) == conditions['star']
        //   ) 
        // }else if (typeof(conditions['star']) == "undefined" && typeof(conditions['genres']) == "undefined"){
        //   filteredData = data.filter(
        //     item => item.subject.year == conditions['year']
        //   ) 
        // }else if (typeof(conditions['year']) == "undefined" && typeof(conditions['star']) == "undefined"){
        //   filteredData = data.filter(
        //     item => item.subject.genres.indexOf(conditions['genres']) > -1
        //   ) 
        // }else if(typeof(conditions['year']) == "undefined"){
        //   filteredData = data.filter(
        //     item => 
        //       Math.round(item.subject.rating.star_count) == conditions['star'] && 
        //       item.subject.genres.indexOf(conditions['genres']) > -1
        //   ) 
        // }else if (typeof(conditions['star']) == "undefined"){
        //   filteredData = data.filter(
        //     item => 
        //       item.subject.year == conditions['year'] && 
        //       item.subject.genres.indexOf(conditions['genres']) > -1
        //   ) 
        // }else if (typeof(conditions['genres']) == "undefined"){
        //   filteredData = data.filter(
        //     item => 
        //       item.subject.year == conditions['year'] && 
        //       Math.round(item.subject.rating.star_count) == conditions['star']
        //   ) 
        // }
        // else{
        //   filteredData = data.filter(
        //     item => 
        //       item.subject.year == conditions['year'] && 
        //       Math.round(item.subject.rating.star_count) == conditions['star'] && 
        //       item.subject.genres.indexOf(conditions['genres']) > -1
        //   ) 
        // }
      }else{
        filteredData = $.parseJSON(JSON.stringify(data));
      }
      // console.log(filteredData);
      // æ¸…ç©ºé¡µé¢
      content.html('');
      updatePage(content, filteredData);
    },
      error: function(xhr, status, error) {
        // å¤„ç†é”™è¯¯æƒ…å†µ
        console.log('è·å–JSONæ•°æ®å¤±è´¥ï¼š' + error);
      }
    });
  }

  /**
   * å¡«å……é¡µé¢æ•°æ®
   * @param content é¡µé¢é¡¶éƒ¨div
   * @param Data æ•°æ®
   * 
  */
  function updatePage(content, Data){
    // å®šä¹‰ç”µå½±æ ‡é¢˜å˜é‡
    let title= '';
    let picNormal = '';
    for(let i=0; i<Data.length; i++){
      // ç”µå½±ä¿¡æ¯
      let subject = Data[i]['subject'];
      // è¯„åˆ†
      let rating = Data[i]['rating'];
      // ç”µå½±é¢˜ç›®
      title = subject['title'];
      // ç”µå½±ä¿¡æ¯
      sharing_url = subject['sharing_url'];
      // ç”µå½±ç…§ç‰‡
      picNormal = subject['pic']['normal'];
      // å®˜æ–¹è¯„åˆ†é›†åˆ
      let ratings = subject['rating'];
      // å®˜æ–¹è¯„åˆ†é›†åˆ - å®˜æ–¹è¯„åˆ†
      let ratings_value = ratings['value'];
      // å®˜æ–¹è¯„åˆ† - å®˜æ–¹è¯„åˆ†æ˜Ÿæ˜Ÿæ•°
      let ratings_star_count = ratings['star_count'];
      // é¢œè‰²é›†åˆ
      let color_scheme = subject['color_scheme'];
      // é¢œè‰²é›†åˆ -ä¸»è¦é¢œè‰²
      let primary_color_light = color_scheme['primary_color_light'];
      let primary_color_dark = color_scheme['primary_color_dark'];
      // é¢œè‰²é›†åˆ - æ¬¡è¦é¢œè‰²
      let secondary_color = color_scheme['secondary_color'];
      
      // åˆ›å»ºæ–°çš„Div
      var newDiv = $("<div></div>");
      var canvasDiv = $("<div></div>");
      newDiv.addClass('list');
      canvasDiv.addClass('d-canvas')
      var newLink = $("<a></a>").attr({
      "href": sharing_url,
      "target": '_blank',
      "alt": title
      });
      // æ˜¾ç¤ºç”µå½±é¢˜ç›®
      var $span = $('<h2>').text(title);
      // æ˜¾ç¤ºç”µå½±ç…§ç‰‡
      var newImg = $("<img />").attr({
      "src": picNormal,
      "alt": title
      });
      // æ˜¾ç¤ºä¸ªäººè¯„åˆ†
      var $span_star = $('<span>');
      
      if (rating != null){
        $span_star.append('ä¸ªäººè¯„åˆ†ï¼š');
        let star_count = rating['star_count'];
        // console.log(star_count);
        for(let j=0; j<star_count; j++){
          $span_star = $span_star.append('â­');
        }
      }else{
        $span_star.append('ä¸ªäººè¯„åˆ†ï¼šæœªè¯„åˆ†');
      }
      var $ratings_star_span = $('<span>');
      $ratings_star_span.append('è±†ç“£è¯„åˆ†ï¼š')
      for(let k=0; k<ratings_star_count; k++){
        $ratings_star_span = $ratings_star_span.append('ğŸŒŸ');
      }

      var ratings_star_canvas = $('<canvas>').attr({
        width: 60,
        height: 60
      });
      ratings_star_canvas.attr('id', 'canvas' + i);
      drawMain(ratings_star_canvas[0], ratings_value*10, '#'+primary_color_dark, '#'+secondary_color);
      $ratings_star_span.append('&nbsp;&nbsp;&nbsp;'+ratings_value+'/10');
      newLink.append(newImg);
      canvasDiv.append(ratings_star_canvas);
      newDiv.append(canvasDiv);
      newDiv.append(newLink);
      newDiv.append($span);
      newDiv.append($span_star);
      newDiv.append($ratings_star_span);
      content.append(newDiv);
      
    }
  }
  

  
</script>
</html>